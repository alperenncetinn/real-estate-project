@inject RealEstate.Web.Services.AuthService AuthService
@inject RealEstate.Web.Services.NotificationService NotificationService
@{
    var isAuthenticated = AuthService.IsAuthenticated();
    var currentUser = AuthService.GetCurrentUser();
    var isAdmin = AuthService.IsAdmin();
    var unreadCount = 0;

    if (isAuthenticated)
    {
        unreadCount = await NotificationService.GetUnreadCountAsync();
    }
}

<ul class="navbar-nav ms-auto gap-2 align-items-center">
    @if (isAuthenticated && currentUser != null)
    {
        <!-- Bildirim Butonu -->
        <li class="nav-item dropdown">
            <a class="nav-link position-relative p-2 rounded-circle" href="#" id="notificationDropdown" role="button" 
               data-bs-toggle="dropdown" aria-expanded="false"
               style="background: linear-gradient(135deg, #fce7f3, #fbcfe8); width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-bell-fill" style="color: #ec4899;"></i>
                @if (unreadCount > 0)
                {
                    <span class="position-absolute badge rounded-pill"
                          style="font-size: 0.6rem; top: -2px; right: -2px; background: linear-gradient(135deg, #f472b6, #ec4899);">
                        @(unreadCount > 9 ? "9+" : unreadCount.ToString())
                    </span>
                }
            </a>
            <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 mt-2" aria-labelledby="notificationDropdown"
                style="min-width: 320px; max-height: 400px; overflow-y: auto; border-radius: 1rem;">
                <li class="dropdown-header d-flex justify-content-between align-items-center px-3 py-2">
                    <span class="fw-bold" style="color: #ec4899;">üîî Bildirimler</span>
                    @if (unreadCount > 0)
                    {
                        <a href="#" class="small text-decoration-none" style="color: #14b8a6;" onclick="markAllNotificationsRead(); return false;">
                            T√ºm√º okundu ‚úì
                        </a>
                    }
                </li>
                <li><hr class="dropdown-divider m-0"></li>
                <li id="notificationList">
                    <div class="text-center text-muted py-4">
                        <div class="spinner-border spinner-border-sm" role="status" style="color: #ec4899;"></div>
                        <small class="d-block mt-2">Y√ºkleniyor...</small>
                    </div>
                </li>
            </ul>
        </li>

        <!-- Kullanici Menu -->
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle d-flex align-items-center gap-2 p-2 rounded-pill" href="#" id="userDropdown" 
               role="button" data-bs-toggle="dropdown" aria-expanded="false"
               style="background: linear-gradient(135deg, #fce7f3, #fbcfe8);">
                <div class="rounded-circle d-flex align-items-center justify-content-center text-white fw-bold"
                     style="width: 34px; height: 34px; background: linear-gradient(135deg, #f472b6, #ec4899); font-size: 0.85rem;">
                    @currentUser.FirstName?.Substring(0, 1).ToUpper()@currentUser.LastName?.Substring(0, 1).ToUpper()
                </div>
                <span class="d-none d-lg-inline fw-semibold pe-1" style="color: #be185d;">@currentUser.FirstName</span>
                @if (isAdmin)
                {
                    <span class="badge text-white" style="background: linear-gradient(135deg, #a855f7, #c084fc); font-size: 0.6rem;">‚ú® Admin</span>
                }
            </a>
            <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 mt-2 p-2" aria-labelledby="userDropdown" 
                style="min-width: 240px; border-radius: 1rem;">
                <li class="px-3 py-2 mb-2 rounded-3" style="background: linear-gradient(135deg, #fdf2f8, #fce7f3);">
                    <div class="fw-bold" style="color: #be185d;">üëã Merhaba, @currentUser.FirstName!</div>
                    <small class="text-muted">@currentUser.Email</small>
                </li>
                <li>
                    <a class="dropdown-item rounded-3 py-2" asp-controller="Auth" asp-action="Profile">
                        <i class="bi bi-person-heart me-2" style="color: #ec4899;"></i>Profilim
                    </a>
                </li>
                <li>
                    <a class="dropdown-item rounded-3 py-2" asp-controller="Listing" asp-action="MyListings">
                        <i class="bi bi-house-heart me-2" style="color: #14b8a6;"></i>ƒ∞lanlarƒ±m
                    </a>
                </li>
                <li>
                    <a class="dropdown-item rounded-3 py-2" asp-controller="Favorite" asp-action="Index">
                        <i class="bi bi-heart-fill me-2" style="color: #f472b6;"></i>Favorilerim
                    </a>
                </li>
                @if (isAdmin)
                {
                    <li><hr class="dropdown-divider my-2"></li>
                    <li class="dropdown-header small" style="color: #a855f7;">‚ú® Y√∂netim Paneli</li>
                    <li>
                        <a class="dropdown-item rounded-3 py-2" asp-controller="Admin" asp-action="Listings">
                            <i class="bi bi-kanban me-2" style="color: #a855f7;"></i>ƒ∞lan Y√∂netimi
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item rounded-3 py-2" asp-controller="Admin" asp-action="Users">
                            <i class="bi bi-people me-2" style="color: #a855f7;"></i>Kullanƒ±cƒ± Y√∂netimi
                        </a>
                    </li>
                }
                <li><hr class="dropdown-divider my-2"></li>
                <li>
                    <form asp-controller="Auth" asp-action="Logout" method="post" class="d-inline w-100">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="dropdown-item rounded-3 py-2 w-100 text-start" style="color: #be185d;">
                            <i class="bi bi-box-arrow-right me-2"></i>√áƒ±kƒ±≈ü Yap üëã
                        </button>
                    </form>
                </li>
            </ul>
        </li>
    }
    else
    {
        <li class="nav-item">
            <a class="btn fw-semibold px-4 rounded-pill" asp-controller="Auth" asp-action="Login"
               style="border: 2px solid #f9a8d4; color: #ec4899;">
                <i class="bi bi-box-arrow-in-right me-1"></i>Giri≈ü Yap
            </a>
        </li>
        <li class="nav-item">
            <a class="btn fw-semibold px-4 rounded-pill text-white" asp-controller="Auth" asp-action="Register"
               style="background: linear-gradient(135deg, #f472b6, #ec4899);">
                <i class="bi bi-person-plus me-1"></i>Kayƒ±t Ol
            </a>
        </li>
    }
</ul>

@if (isAuthenticated)
{
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            loadNotifications();
        });

        document.getElementById('notificationDropdown')?.addEventListener('show.bs.dropdown', function () {
            loadNotifications();
        });

        async function loadNotifications() {
            try {
                const response = await fetch('/Notification/GetNotifications');
                const data = await response.json();

                const list = document.getElementById('notificationList');
                if (!list) return;

                if (data.length === 0) {
                    list.innerHTML = `
                        <div class="text-center py-4">
                            <span style="font-size: 3rem;">üîï</span>
                            <p class="text-muted small mt-2 mb-0">Bildirim yok</p>
                        </div>`;
                    return;
                }

                let html = '';
                data.forEach(n => {
                    const emoji = n.type === 'warning' ? '‚ö†Ô∏è' : n.type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
                    const readClass = n.isRead ? 'opacity-50' : '';
                    html += `
                        <a href="#" class="dropdown-item rounded-3 py-2 px-3 ${readClass}" onclick="handleNotificationClick(${n.id}, ${n.listingId}); return false;">
                            <div class="d-flex align-items-start gap-2">
                                <span style="font-size: 1.2rem;">${emoji}</span>
                                <div class="flex-grow-1">
                                    <div class="fw-semibold small" style="color: #be185d;">${n.title}</div>
                                    <div class="small text-muted text-wrap" style="line-height: 1.3;">${n.message}</div>
                                    <div class="small text-muted mt-1">
                                        üïê ${new Date(n.createdAt).toLocaleString('tr-TR')}
                                    </div>
                                </div>
                            </div>
                        </a>
                    `;
                });
                list.innerHTML = html;
            } catch (e) {
                console.error('Error loading notifications:', e);
            }
        }

        async function handleNotificationClick(id, listingId) {
            await fetch(`/Notification/MarkAsRead/${id}`, { method: 'POST' });
            if (listingId) {
                window.location.href = `/Listing/Details/${listingId}`;
            } else {
                loadNotifications();
            }
        }

        async function markAllNotificationsRead() {
            await fetch('/Notification/MarkAllAsRead', { method: 'POST' });
            loadNotifications();
            const badge = document.querySelector('#notificationDropdown .badge');
            if (badge) badge.remove();
        }
    </script>
}